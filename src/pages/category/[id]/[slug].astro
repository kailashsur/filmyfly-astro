---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import MovieCard from '../../../components/MovieCard.astro';
import Pagination from '../../../components/Pagination.astro';

import { getCategoryBySlug, getPublicSettings } from '../../../lib/api';
import { generateCategorySEO } from '../../../lib/seo';

export const prerender = false; // ðŸ”¥ KEY LINE

const { id, slug } = Astro.params;
const page = parseInt(Astro.url.searchParams.get('page') || '1');

const categoryData = await getCategoryBySlug(slug!, page);
const settingsData = await getPublicSettings();

if (!categoryData.success || !categoryData.data) {
  return new Response('Not Found', { status: 404 });
}

const { category, movies, pagination } = categoryData.data;
const settings = settingsData.data || {};

const seo = generateCategorySEO(category);
---
<BaseLayout seo={seo} settings={settings}>
  <Header />

  <h2 style="text-align:center;">ðŸ“‚ {category.name} ðŸ“‚</h2>

  {movies?.length ? (
    <>
      {movies.map(movie => (
        <MovieCard movie={movie} />
      ))}

      <Pagination
        currentPage={pagination.page}
        totalPages={pagination.totalPages}
        hasNextPage={pagination.hasNextPage}
        hasPrevPage={pagination.hasPrevPage}
        baseUrl={`/category/${id}/${slug}`}
      />
    </>
  ) : (
    <p style="text-align:center;">No movies found.</p>
  )}

  <Footer />
</BaseLayout>
